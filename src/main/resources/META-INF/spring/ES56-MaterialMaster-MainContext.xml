<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:camel="http://camel.apache.org/schema/spring"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd        http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd">
    <import resource="./ES56-MaterialMaster-BeanDefinition.xml"/>
    <import resource="./ES56-MaterialMaster-TransformationRoute.xml"/>
    <camelContext id="camelContext-Packs" streamCache="true"
        trace="false" xmlns="http://camel.apache.org/schema/spring">
        <routeContextRef ref="Id_MaterialMasterTransformationRoute"/>
        <endpoint id="Materialmaster_SAP_To_CDM_Transformation" uri="dozer:Materialmaster_SAP_To_CDM_Transformation?sourceModel=com.oup.integration.sps.materialmaster.sap.pojo.MaterialMasterSAP&amp;targetModel=com.oup.integration.sps.materialmaster.cdm.pojo.MaterialMasterCDM&amp;mappingFile=Transformations/MaterialMaster_SAP_To_CDM_Transformation.xml"/>
        <endpoint id="Materialmaster_CDM_To_Biblio_Transformation" uri="dozer:MMaterialmaster_CDM_To_Biblio_Transformation?sourceModel=com.oup.integration.sps.materialmaster.cdm.pojo.MaterialMasterCDM&amp;targetModel=com.oup.integration.sps.materialmaster.biblio.pojo.MaterialMasterBiblio&amp;marshalId=transform-json&amp;mappingFile=Transformations/MaterialMaster_CDM_To_Biblio_Transformation.xml"/>
        <dataFormats>
            <json id="transform-json" library="Jackson"/>
        </dataFormats>
        <route id="route_ES56">
            <from id="Id" uri="ftp:{{ftp.drop.server}}:{{ftp.drop.port}}//{{ftp.drop.location}}?password={{ftp.drop.password}}&amp;username={{ftp.drop.username}}&amp;passiveMode=true&amp;filter=#FileFilter&amp;doneFileName=${file:name.noext}.go&amp;include=.*.dat&amp;move=#FileRename"/>
            <setHeader headerName="RequestReceivedTime" id="Id_RequestReceivedTimeFromBiblioForSR">
                <simple>${date:now:HHmmssSSS}</simple>
            </setHeader>
            <setHeader headerName="InterfaceName" id="Id_InterfaceNameForSR">
                <simple>es56</simple>
            </setHeader>
            <log id="Id_StartingSplitPacks" logName="com.oup.sps"
                loggingLevel="INFO" message="Incoming SAP Request ${body}"/>
            <to id="id_BackUpReceivedFile" uri="file:{{file.backup.location}}/1.0 ReceivedFromSAP?fileName=${date:now:yyyy/MM/dd/}$simple{header.DestinationFileName}_$simple{header.RequestReceivedTime}.dat"/>
            <camel:convertBodyTo id="_convertBodyTo1" type="String"/>
            <split id="splitBynewLine">
                <tokenize token="\r\n|\n" trim="true"/>
                <choice id="choiceFilter">
                    <when id="whenCondition">
                        <simple>${header.CamelSplitComplete} == "false" and ${header.CamelSplitIndex} != 0 </simple>
                        <log id="_log2" logName="com.oup.sps"
                            loggingLevel="INFO" message="inside split ${body}"/>
                        <unmarshal id="Id_unmarshalRequisitionsCSV">
                            <bindy
                                classType="com.oup.integration.sps.materialmaster.sap.pojo.MaterialMasterSAP" type="Csv"/>
                        </unmarshal>
                        <to id="_to2" uri="direct:transform_sap_to_cdm"/>
                        <to id="_to3" uri="direct:transform_cdm_to_biblio"/>
                        <log id="ES56logger" logName="com.oup.sps"
                            loggingLevel="INFO" message="Processing SAP split Message ${body}"/>
                        <to id="_to1" uri="activemq:{{activemq.queuename}}"/>
                        <log id="ES56Logger" logName="com.oup.sps"
                            loggingLevel="INFO" message="Message persisted to queue {{activemq.queuename}} "/>
                    </when>
                </choice>
            </split>
        </route>
    </camelContext>
</beans>
